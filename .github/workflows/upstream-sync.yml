name: Upstream Sync (openclaw/main -> your main -> custom PR)

on:
  schedule:
    - cron: "17 2 * * *" # daily UTC 02:17 (Tokyo 11:17)
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  sync-and-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Sync main with upstream/main (ff-only)
        id: sync
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git remote add upstream https://github.com/openclaw/openclaw.git || true
          git fetch upstream main
          git checkout main

          BEFORE="$(git rev-parse HEAD)"
          git merge --ff-only upstream/main
          AFTER="$(git rev-parse HEAD)"

          if [ "$BEFORE" = "$AFTER" ]; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Push synced main
        if: steps.sync.outputs.changed == 'true'
        run: git push origin main

      - name: Create/refresh PR (main -> custom)
        if: steps.sync.outputs.changed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          BASE="fix/discord-reaction-state-machine-only"
          HEAD="main"

          PR_NUMBER="$(gh pr list \
            --base "$BASE" \
            --head "$HEAD" \
            --state open \
            --json number \
            --jq '.[0].number')"

          if [ -z "$PR_NUMBER" ]; then
            gh pr create \
              --base "$BASE" \
              --head "$HEAD" \
              --title "chore(sync): merge upstream main into $BASE" \
              --body "Automated daily upstream sync.\n\n- Source: openclaw/main\n- Mirror branch: main\n- Target: $BASE"
          else
            gh pr comment "$PR_NUMBER" --body "Upstream sync updated main again. Please re-run CI and merge when green."
          fi
