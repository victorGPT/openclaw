name: Daily Upstream Sync

on:
  schedule:
    # æ¯å¤©æ—©ä¸Š 8:00 UTC
    - cron: '0 8 * * *'
  workflow_dispatch:

env:
  UPSTREAM_REPO: openclaw/openclaw
  UPSTREAM_BRANCH: main
  TARGET_BRANCH: upstream-main

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/${{ env.UPSTREAM_REPO }}.git || true
          git fetch upstream

      - name: Check if target branch exists
        id: check-branch
        run: |
          if git show-ref --verify --quiet refs/remotes/origin/${{ env.TARGET_BRANCH }}; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create or update target branch
        id: sync
        run: |
          if [ "${{ steps.check-branch.outputs.exists }}" == "false" ]; then
            git checkout -b ${{ env.TARGET_BRANCH }} upstream/${{ env.UPSTREAM_BRANCH }}
            git push origin ${{ env.TARGET_BRANCH }}
            echo "status=created" >> $GITHUB_OUTPUT
            echo "message=é¦–æ¬¡åˆ›å»º ${{ env.TARGET_BRANCH }} åˆ†æ”¯" >> $GITHUB_OUTPUT
          else
            git checkout ${{ env.TARGET_BRANCH }}
            LOCAL_COMMIT=$(git rev-parse HEAD)
            UPSTREAM_COMMIT=$(git rev-parse upstream/${{ env.UPSTREAM_BRANCH }})
            
            if [ "$LOCAL_COMMIT" == "$UPSTREAM_COMMIT" ]; then
              echo "status=up-to-date" >> $GITHUB_OUTPUT
              echo "message=æ— éœ€æ›´æ–°ï¼Œå·²æ˜¯æœ€æ–°" >> $GITHUB_OUTPUT
            else
              git merge --no-commit --no-ff upstream/${{ env.UPSTREAM_BRANCH }} || MERGE_FAILED=true
              
              if [ "$MERGE_FAILED" == "true" ]; then
                git merge --abort 2>/dev/null || true
                echo "status=conflict" >> $GITHUB_OUTPUT
                echo "message=åŒæ­¥å¤±è´¥ï¼šå­˜åœ¨å†²çªéœ€è¦æ‰‹åŠ¨è§£å†³" >> $GITHUB_OUTPUT
                exit 1
              else
                git merge --abort 2>/dev/null || true
                git reset --hard upstream/${{ env.UPSTREAM_BRANCH }}
                git push origin ${{ env.TARGET_BRANCH }} --force-with-lease
                
                COMMITS_BEHIND=$(git rev-list --count HEAD..upstream/${{ env.UPSTREAM_BRANCH }} 2>/dev/null || echo "0")
                COMMIT_MSG=$(git log -1 --pretty=format:"%s" upstream/${{ env.UPSTREAM_BRANCH }})
                echo "status=updated" >> $GITHUB_OUTPUT
                echo "message=å·²åŒæ­¥ ${{ env.UPSTREAM_REPO }}@${{ env.UPSTREAM_BRANCH }}" >> $GITHUB_OUTPUT
                echo "commits=$COMMITS_BEHIND" >> $GITHUB_OUTPUT
                echo "commit_msg=$COMMIT_MSG" >> $GITHUB_OUTPUT
              fi
            fi
          fi

      - name: Notify Discord - Success
        if: success() && steps.sync.outputs.status != ''
        uses: Ilshidur/action-discord@master
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_UPSTREAM_SYNC_WEBHOOK }}
        with:
          args: |
            ğŸ”„ **ä¸Šæ¸¸åŒæ­¥æŠ¥å‘Š**
            
            ğŸ“‹ çŠ¶æ€: ${{ steps.sync.outputs.status == 'created' && 'ğŸ†• é¦–æ¬¡åˆ›å»º' || steps.sync.outputs.status == 'up-to-date' && 'âœ… å·²æ˜¯æœ€æ–°' || steps.sync.outputs.status == 'updated' && 'ğŸ“¥ å·²æ›´æ–°' || steps.sync.outputs.status }}
            
            ğŸ“ ${{ steps.sync.outputs.message }}
            ${{ steps.sync.outputs.commits && format('ğŸ“Š è½åæäº¤æ•°: {0}', steps.sync.outputs.commits) || '' }}
            ${{ steps.sync.outputs.commit_msg && format('ğŸ’¬ æœ€æ–°æäº¤: {0}', steps.sync.outputs.commit_msg) || '' }}
            
            ğŸ”— åˆ†æ”¯: `${{ env.TARGET_BRANCH }}`
            â° æ—¶é—´: ${{ github.event.schedule || 'æ‰‹åŠ¨è§¦å‘' }}

      - name: Notify Discord - Failure
        if: failure()
        uses: Ilshidur/action-discord@master
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_UPSTREAM_SYNC_WEBHOOK }}
        with:
          args: |
            âŒ **ä¸Šæ¸¸åŒæ­¥å¤±è´¥**
            
            ğŸ”´ çŠ¶æ€: åŒæ­¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯
            
            ğŸ“ ${{ steps.sync.outputs.message || 'æœªçŸ¥é”™è¯¯' }}
            
            ğŸ”— ç›®æ ‡åˆ†æ”¯: `${{ env.TARGET_BRANCH }}`
            â¬†ï¸ ä¸Šæ¸¸: `${{ env.UPSTREAM_REPO }}:${{ env.UPSTREAM_BRANCH }}`
            
            ğŸ“ æŸ¥çœ‹è¿è¡Œæ—¥å¿—: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            â° æ—¶é—´: ${{ github.event.schedule || 'æ‰‹åŠ¨è§¦å‘' }}
