name: Upstream Sync

on:
  schedule:
    - cron: "17 2 * * *" # daily UTC 02:17 (Tokyo 11:17)
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  sync-and-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Sync upstream-main with upstream/main (ff-only)
        id: sync
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git remote add upstream https://github.com/openclaw/openclaw.git || true
          git fetch upstream main
          git fetch origin upstream-main || true

          if git show-ref --verify --quiet refs/remotes/origin/upstream-main; then
            git checkout -B upstream-main origin/upstream-main
            BEFORE="$(git rev-parse HEAD)"
            git merge --ff-only upstream/main
          else
            git checkout -B upstream-main upstream/main
            BEFORE=""
          fi

          AFTER="$(git rev-parse HEAD)"

          if [ -n "$BEFORE" ] && [ "$BEFORE" = "$AFTER" ]; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Push synced mirror branch
        if: steps.sync.outputs.changed == 'true'
        run: git push origin upstream-main

      - name: Create/refresh PR (upstream-main -> custom)
        if: steps.sync.outputs.changed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          BASE="fix/discord-reaction-state-machine-only"
          HEAD="upstream-main"

          PR_NUMBER="$(gh pr list \
            --base "$BASE" \
            --head "$HEAD" \
            --state open \
            --json number \
            --jq '.[0].number')"

          if [ -z "$PR_NUMBER" ]; then
            cat > /tmp/upstream-sync-pr-body.md <<EOF
Automated daily upstream sync.

- Source: openclaw/main
- Mirror branch: upstream-main
- Target: $BASE
EOF
            gh pr create \
              --base "$BASE" \
              --head "$HEAD" \
              --title "chore(sync): merge upstream main into $BASE" \
              --body-file /tmp/upstream-sync-pr-body.md
          else
            gh pr comment "$PR_NUMBER" --body "Upstream sync updated upstream-main again. Please re-run CI and merge when green."
          fi
